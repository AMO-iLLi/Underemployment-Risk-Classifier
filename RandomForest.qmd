---
title: "RandomForest"
format: html
---

# Libraries
```{r}
library(tidyverse)
library(ranger)
library(randomForest)

set.seed(345)
```

# Read data
```{r}

sample_submission <- read_csv("sample_submission.csv")
test_set <- read_csv("test.csv")

train_set <- read_csv(
  "train.csv",
  col_types = cols(
    id            = col_double(),
    
    # Target
    overqualified = col_double(),
    
    # Education & Program Features
    CERTLEVP  = col_factor(),
    PGMCIPAP  = col_factor(),
    PGM_P034  = col_factor(),
    PGM_P036  = col_factor(),
    HLOSGRDP  = col_factor(),
    PREVLEVP  = col_factor(),
    
    # Program Experience
    PGM_280A  = col_factor(),
    PGM_280B  = col_factor(),
    PGM_280C  = col_factor(),
    PGM_280F  = col_factor(),
    PGM_P401 = col_factor(),
    
    # Financial
    STULOANS  = col_factor(),
    DBTOTGRD = col_factor(),
    SCHOLARP = col_factor(),
    
    # Demographic
    GRADAGEP = col_factor(),
    GENDER2  = col_factor(),
    CTZSHIPP = col_factor(),
    VISBMINP = col_factor(),
    DDIS_FL  = col_factor(),
    
    # Parental education
    PAR1GRD = col_factor(),
    PAR2GRD = col_factor(),
    
    # Pre-program work
    BEF_P140 = col_factor(),
    BEF_160  = col_double(),
    overqualified = col_factor()
  )
)

# Replace NA with 999 (keep factor columns as factors)
replace_na_999 <- function(df) {
  df %>%
    mutate(
      across(where(is.factor), ~ forcats::fct_explicit_na(.x, na_level = "999")),
      across(where(is.character), ~ tidyr::replace_na(.x, "999")),
      across(where(is.numeric), ~ tidyr::replace_na(.x, 999))
    )
}

train_set <- replace_na_999(train_set)
test_set  <- replace_na_999(test_set)

sapply(train_set, function(x) sum(is.na(x)))
levels(train_set$CERTLEVP)

train_set <- train_set %>% select(-id)
test_set  <- test_set  %>% select(-id)

train_set$overqualified <- as.factor(train_set$overqualified)

```

# Splitting data
```{r}
n <- nrow(train_set)

prop_train <- 0.75
prop_test <- 0.25

train_test <- sample(c("Train", "Test"),
                     size = n, replace = TRUE, 
                     prob = c(prop_train, prop_test))

training_data <- train_set[train_test == "Train", ]
testing_data <- train_set[train_test == "Test",]
```

# Random Forest
```{r}

#the one that worked 
set.seed(42)
rf_model <- randomForest(
  overqualified ~ .,
  data = train_set,
  ntree = 700,
  mtry = 9,
  classwt = c("0" = 1, "1" = 2),
  importance = TRUE
)
rf_model




all_mtry <- c(6,7,8,9,10,11)
all_nodesize <- c(1,2,3,5,8,10,15,20)
all_pars <- expand.grid(mtry = all_mtry, nodesize = all_nodesize)
n_pars <- nrow(all_pars)

```

# Visuals
```{r}
plot(pro_rf, main = "OOB Error")

plot(pro_rf, xlim = c(50, 1000), ylim = c(0.6, 0.8))

hist(treesize(pro_rf))

print(pro_rf)
varImpPlot(pro_rf)
```
